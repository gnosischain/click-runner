services:
  click-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: click-runner
    volumes:
      - ./queries:/app/queries
    environment:
      CH_HOST: ${CH_DB_HOST}
      CH_PORT: ${CH_NATIVE_PORT}
      CH_USER: ${CH_USER}
      CH_PASSWORD: ${CH_PASSWORD}
      CH_DB: ${CH_DB}
      CH_SECURE: ${CH_SECURE}
      CH_VERIFY: "False"
      
      # Default ingestor type
      CH_INGESTOR: ${CH_INGESTOR:-query}
      
      # For CSV ingestor (Ember)
      CH_EMBER_CREATE_TABLE: ${CH_EMBER_CREATE_TABLE:-queries/ember/create_ember_table.sql}
      CH_EMBER_INSERT: ${CH_EMBER_INSERT:-queries/ember/insert_ember_data.sql}
      CH_EMBER_OPTIMIZE: ${CH_EMBER_OPTIMIZE:-queries/ember/optimize_ember_data.sql}
      
      # Query variables
      CH_QUERY_VAR_S3_ACCESS_KEY: ${CH_QUERY_VAR_S3_ACCESS_KEY:-}
      CH_QUERY_VAR_S3_SECRET_KEY: ${CH_QUERY_VAR_S3_SECRET_KEY:-}
      CH_QUERY_VAR_S3_BUCKET: ${CH_QUERY_VAR_S3_BUCKET:-}
      CH_QUERY_VAR_S3_REGION: ${CH_QUERY_VAR_S3_REGION:-}
      
  # Example service for Ember data ingestion
  ember-ingestor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ember-ingestor
    volumes:
      - ./queries:/app/queries
    environment:
      CH_HOST: ${CH_DB_HOST}
      CH_PORT: ${CH_NATIVE_PORT}
      CH_USER: ${CH_USER}
      CH_PASSWORD: ${CH_PASSWORD}
      CH_DB: ${CH_DB}
      CH_SECURE: ${CH_SECURE}
      CH_VERIFY: "False"
      
      CH_QUERY_VAR_EMBER_DATA_URL: ${EMBER_DATA_URL:-https://example.com/path/to/ember/data.csv}

      # Variables specific to Ember data
      CH_QUERY_VAR_S3_ACCESS_KEY: ${CH_QUERY_VAR_S3_ACCESS_KEY:-}
      CH_QUERY_VAR_S3_SECRET_KEY: ${CH_QUERY_VAR_S3_SECRET_KEY:-}
      CH_QUERY_VAR_S3_BUCKET: ${CH_QUERY_VAR_S3_BUCKET:-}
      CH_QUERY_VAR_S3_REGION: ${CH_QUERY_VAR_S3_REGION:-}
    command: >
      --ingestor=csv
      --create-table-sql=queries/ember/create_ember_table.sql
      --insert-sql=queries/ember/insert_ember_data.sql
      --optimize-sql=queries/ember/optimize_ember_data.sql
    
  # Example service for ProbeLab data ingestion
  probelab-agent-semvers-ingestor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: probelab-agent-semvers-ingestor
    volumes:
      - ./queries:/app/queries
    environment:
      CH_HOST: ${CH_DB_HOST}
      CH_PORT: ${CH_NATIVE_PORT}
      CH_USER: ${CH_USER}
      CH_PASSWORD: ${CH_PASSWORD}
      CH_DB: ${CH_DB}
      CH_SECURE: ${CH_SECURE}
      CH_VERIFY: "False"
      
      # S3 credentials
      CH_QUERY_VAR_S3_ACCESS_KEY: ${CH_QUERY_VAR_S3_ACCESS_KEY:-}
      CH_QUERY_VAR_S3_SECRET_KEY: ${CH_QUERY_VAR_S3_SECRET_KEY:-}
      CH_QUERY_VAR_S3_BUCKET: ${CH_QUERY_VAR_S3_BUCKET:-}
      CH_QUERY_VAR_S3_REGION: ${CH_QUERY_VAR_S3_REGION:-}
    command: >
      --ingestor=parquet
      --create-table-sql=queries/probelab/probelab_agent_semvers_avg_1d.up.sql
      --s3-path=assets/agent_semvers_avg_1d_data/{{DATE}}.parquet
      --table-name=crawlers_data.probelab_agent_semvers_avg_1d
      --mode=all

  probelab-all-ingestor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: probelab-all-ingestor
    volumes:
      - ./queries:/app/queries
    environment:
      CH_HOST: ${CH_DB_HOST}
      CH_PORT: ${CH_NATIVE_PORT}
      CH_USER: ${CH_USER}
      CH_PASSWORD: ${CH_PASSWORD}
      CH_DB: ${CH_DB}
      CH_SECURE: ${CH_SECURE}
      CH_VERIFY: "False"
      CH_QUERY_VAR_S3_ACCESS_KEY: ${CH_QUERY_VAR_S3_ACCESS_KEY:-}
      CH_QUERY_VAR_S3_SECRET_KEY: ${CH_QUERY_VAR_S3_SECRET_KEY:-}
      CH_QUERY_VAR_S3_BUCKET: ${CH_QUERY_VAR_S3_BUCKET:-}
      CH_QUERY_VAR_S3_REGION: ${CH_QUERY_VAR_S3_REGION:-}
    entrypoint: []
    command: >
      /bin/bash -c "
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_semvers_avg_1d.up.sql --s3-path=assets/agent_semvers_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_semvers_avg_1d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_semvers_over_7d.up.sql --s3-path=assets/agent_semvers_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_semvers_over_7d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_types_avg_1d.up.sql --s3-path=assets/agent_types_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_types_avg_1d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_types_over_7d.up.sql --s3-path=assets/agent_types_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_types_over_7d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_cloud_provider_avg_1d.up.sql --s3-path=assets/cloud_provider_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_cloud_provider_avg_1d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_cloud_provider_over_7d.up.sql --s3-path=assets/cloud_provider_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_cloud_provider_over_7d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_countries_avg_1d.up.sql --s3-path=assets/countries_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_countries_avg_1d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_countries_over_7d.up.sql --s3-path=assets/countries_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_countries_over_7d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_discv5_stale_records.up.sql --s3-path=assets/discv5_stale_records_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_discv5_stale_records --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_is_cloud_avg_1d.up.sql --s3-path=assets/is_cloud_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_is_cloud_avg_1d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_is_cloud_over_7d.up.sql --s3-path=assets/is_cloud_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_is_cloud_over_7d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_protocols_support_over_7d.up.sql --s3-path=assets/protocols_support_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_protocols_support_over_7d --mode=all && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_quic_support_over_7d.up.sql --s3-path=assets/quic_support_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_quic_support_over_7d --mode=all
      "

  probelab-date-ingestor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: probelab-date-ingestor
    volumes:
      - ./queries:/app/queries
    environment:
      CH_HOST: ${CH_DB_HOST}
      CH_PORT: ${CH_NATIVE_PORT}
      CH_USER: ${CH_USER}
      CH_PASSWORD: ${CH_PASSWORD}
      CH_DB: ${CH_DB}
      CH_SECURE: ${CH_SECURE}
      CH_VERIFY: "False"
      CH_QUERY_VAR_S3_ACCESS_KEY: ${CH_QUERY_VAR_S3_ACCESS_KEY:-}
      CH_QUERY_VAR_S3_SECRET_KEY: ${CH_QUERY_VAR_S3_SECRET_KEY:-}
      CH_QUERY_VAR_S3_BUCKET: ${CH_QUERY_VAR_S3_BUCKET:-}
      CH_QUERY_VAR_S3_REGION: ${CH_QUERY_VAR_S3_REGION:-}
    entrypoint: []
    command: >
      /bin/bash -c "
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_semvers_avg_1d.up.sql --s3-path=assets/agent_semvers_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_semvers_avg_1d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_semvers_over_7d.up.sql --s3-path=assets/agent_semvers_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_semvers_over_7d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_types_avg_1d.up.sql --s3-path=assets/agent_types_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_types_avg_1d --mode=date  --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_types_over_7d.up.sql --s3-path=assets/agent_types_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_types_over_7d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_cloud_provider_avg_1d.up.sql --s3-path=assets/cloud_provider_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_cloud_provider_avg_1d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_cloud_provider_over_7d.up.sql --s3-path=assets/cloud_provider_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_cloud_provider_over_7d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_countries_avg_1d.up.sql --s3-path=assets/countries_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_countries_avg_1d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_countries_over_7d.up.sql --s3-path=assets/countries_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_countries_over_7d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_discv5_stale_records.up.sql --s3-path=assets/discv5_stale_records_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_discv5_stale_records --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_is_cloud_avg_1d.up.sql --s3-path=assets/is_cloud_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_is_cloud_avg_1d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_is_cloud_over_7d.up.sql --s3-path=assets/is_cloud_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_is_cloud_over_7d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_protocols_support_over_7d.up.sql --s3-path=assets/protocols_support_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_protocols_support_over_7d --mode=date --date=2025-04-22 && \
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_quic_support_over_7d.up.sql --s3-path=assets/quic_support_over_7d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_quic_support_over_7d --mode=date --date=2025-04-22
      "

  probelab-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: probelab-test
    volumes:
      - ./queries:/app/queries
    environment:
      CH_HOST: ${CH_DB_HOST}
      CH_PORT: ${CH_NATIVE_PORT}
      CH_USER: ${CH_USER}
      CH_PASSWORD: ${CH_PASSWORD}
      CH_DB: ${CH_DB}
      CH_SECURE: ${CH_SECURE}
      CH_VERIFY: "False"
      CH_QUERY_VAR_S3_ACCESS_KEY: ${CH_QUERY_VAR_S3_ACCESS_KEY:-}
      CH_QUERY_VAR_S3_SECRET_KEY: ${CH_QUERY_VAR_S3_SECRET_KEY:-}
      CH_QUERY_VAR_S3_BUCKET: ${CH_QUERY_VAR_S3_BUCKET:-}
      CH_QUERY_VAR_S3_REGION: ${CH_QUERY_VAR_S3_REGION:-}
    entrypoint: []
    command: >
      /bin/bash -c "
      python run_queries.py --ingestor=parquet --create-table-sql=queries/probelab/probelab_agent_semvers_avg_1d.up.sql --s3-path=assets/agent_semvers_avg_1d_data/{{DATE}}.parquet --table-name=crawlers_data.probelab_agent_semvers_avg_1d --mode=latest
      "
  gpay-wallets-ingestor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gpay-wallets-ingestor
    volumes:
      - ./queries:/app/queries
      - ${GOOGLE_APPLICATION_CREDENTIALS:-~/.config/gcloud/application_default_credentials.json}:/app/credentials.json
    environment:
      CH_HOST: ${CH_DB_HOST}
      CH_PORT: ${CH_NATIVE_PORT}
      CH_USER: ${CH_USER}
      CH_PASSWORD: ${CH_PASSWORD}
      CH_DB: ${CH_DB}
      CH_SECURE: ${CH_SECURE}
      CH_VERIFY: "False"
      
      # Google Drive specific variables
      GOOGLE_APPLICATION_CREDENTIALS: /app/credentials.json
      CH_QUERY_VAR_GOOGLE_APPLICATION_CREDENTIALS: /app/credentials.json
      CH_GDRIVE_FILE_ID: ${GPAY_WALLETS_FILE_ID:-}
      CH_TABLE_NAME: crawlers_data.gpay_wallets
    command: >
      --ingestor=gdrive
      --create-table-sql=queries/gpay/create_gpay_wallets_table.sql
      --optimize-sql=queries/gpay/optimize_gpay_wallets_data.sql
      --file-id=${GPAY_WALLETS_FILE_ID:-}
      --table-name=crawlers_data.gpay_wallets
      --max-rows=1000000